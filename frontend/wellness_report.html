<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness Assessment Report - Celloxen</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .navy-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .navy-bg { background-color: #1e3a8a; }
        .navy-text { color: #1e3a8a; }
        .btn-navy { background: #1e3a8a; transition: all 0.3s ease; }
        .btn-navy:hover { background: #1e293b; transform: translateY(-2px); }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .score-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
        .score-fill { height: 100%; border-radius: 4px; transition: width 1s ease-out; }
        @media print {
            .no-print { display: none !important; }
            .navy-gradient { background: #1e3a8a !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        const WellnessReport = () => {
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [data, setData] = React.useState(null);

            React.useEffect(() => {
                fetchReport();
            }, []);

            const fetchReport = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const assessmentId = urlParams.get('assessmentId');
                
                if (!assessmentId) {
                    setError('No assessment ID provided');
                    setLoading(false);
                    return;
                }

                try {
                    const token = localStorage.getItem('celloxen_token');
                    const response = await fetch(`/api/v1/assessment/${assessmentId}/report`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch report');
                    
                    const result = await response.json();
                    setData(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            };

            const getScoreColor = (score) => {
                if (score >= 80) return 'bg-green-500';
                if (score >= 60) return 'bg-yellow-500';
                if (score >= 40) return 'bg-orange-500';
                return 'bg-red-500';
            };

            const getStatusColor = (status) => {
                if (status === 'High') return 'text-red-600 bg-red-50';
                if (status === 'Moderate') return 'text-yellow-600 bg-yellow-50';
                return 'text-green-600 bg-green-50';
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center navy-gradient">
                        <div className="text-center text-white">
                            <div className="spinner mx-auto mb-4"></div>
                            <p className="text-xl">Loading Wellness Report...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-md">
                            <div className="text-red-500 text-5xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">Error Loading Report</h2>
                            <p className="text-gray-600 mb-4">{error}</p>
                            <button onClick={() => { if (window.history.length > 1) window.history.back(); else window.close(); }} className="btn-navy text-white px-6 py-2 rounded-lg">
                                Go Back
                            </button>
                        </div>
                    </div>
                );
            }

            const { assessment, patient } = data;
            const aiReport = assessment.ai_report || {};

            return (
                <div className="min-h-screen bg-gray-100 py-8 px-4">
                    <div className="max-w-5xl mx-auto">
                        {/* Header */}
                        <div className="navy-gradient rounded-2xl p-8 mb-6 text-white">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h1 className="text-3xl font-bold mb-2">Wellness Assessment Report</h1>
                                    <p className="text-blue-200">Comprehensive Health & Wellness Analysis</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-2xl font-bold">{patient.first_name} {patient.last_name}</p>
                                    <p className="text-blue-200">{patient.patient_number}</p>
                                    <p className="text-blue-200 text-sm mt-1">{formatDate(assessment.created_at)}</p>
                                </div>
                            </div>
                        </div>

                        {/* Print Button */}
                        <div className="mb-6 no-print flex justify-end space-x-3">
                            <button onClick={() => { if (window.history.length > 1) window.history.back(); else window.close(); }} className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                ‚Üê Back
                            </button>
                            <button onClick={() => window.print()} className="btn-navy text-white px-6 py-2 rounded-lg flex items-center">
                                üñ®Ô∏è Print Report
                            </button>
                        </div>

                        {/* Overall Score */}
                        <div className="bg-white rounded-2xl p-8 mb-6 shadow-sm">
                            <div className="text-center">
                                <h2 className="text-xl font-semibold text-gray-700 mb-4">Overall Wellness Score</h2>
                                <div className="relative inline-block">
                                    <div className={`w-32 h-32 rounded-full flex items-center justify-center ${getScoreColor(assessment.overall_score)}`}>
                                        <span className="text-4xl font-bold text-white">{Math.round(assessment.overall_score)}%</span>
                                    </div>
                                </div>
                                <p className="mt-4 text-lg text-gray-600">
                                    {aiReport.wellness_overview?.overall_status || 'Assessment Complete'}
                                </p>
                            </div>
                        </div>

                        {/* Executive Summary */}
                        {aiReport.executive_summary && (
                            <div className="bg-white rounded-2xl p-8 mb-6 shadow-sm">
                                <h2 className="text-xl font-bold navy-text mb-4 flex items-center">
                                    <span className="mr-2">üìã</span> Executive Summary
                                </h2>
                                <p className="text-gray-700 leading-relaxed">{aiReport.executive_summary}</p>
                            </div>
                        )}

                        {/* Domain Scores */}
                        <div className="bg-white rounded-2xl p-8 mb-6 shadow-sm">
                            <h2 className="text-xl font-bold navy-text mb-6 flex items-center">
                                <span className="mr-2">üìä</span> Wellness Domain Scores
                            </h2>
                            <div className="space-y-4">
                                {[
                                    { name: 'Energy & Vitality', score: assessment.energy_score, icon: '‚ö°' },
                                    { name: 'Comfort & Mobility', score: assessment.comfort_score, icon: 'ü¶¥' },
                                    { name: 'Circulation & Heart', score: assessment.circulation_score, icon: '‚ù§Ô∏è' },
                                    { name: 'Stress & Relaxation', score: assessment.stress_score, icon: 'üßò' },
                                    { name: 'Metabolic Balance', score: assessment.metabolic_score, icon: 'üî•' }
                                ].map((domain, idx) => (
                                    <div key={idx} className="flex items-center">
                                        <span className="text-2xl mr-3">{domain.icon}</span>
                                        <div className="flex-1">
                                            <div className="flex justify-between mb-1">
                                                <span className="font-medium text-gray-700">{domain.name}</span>
                                                <span className="font-bold navy-text">{Math.round(domain.score)}%</span>
                                            </div>
                                            <div className="score-bar">
                                                <div className={`score-fill ${getScoreColor(domain.score)}`} style={{width: `${domain.score}%`}}></div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Domain Analysis */}
                        {aiReport.domain_analysis && (
                            <div className="bg-white rounded-2xl p-8 mb-6 shadow-sm">
                                <h2 className="text-xl font-bold navy-text mb-6 flex items-center">
                                    <span className="mr-2">üîç</span> Detailed Domain Analysis
                                </h2>
                                <div className="grid md:grid-cols-2 gap-6">
                                    {Object.entries(aiReport.domain_analysis).map(([key, domain], idx) => (
                                        <div key={idx} className="border border-gray-200 rounded-xl p-5">
                                            <div className="flex justify-between items-start mb-3">
                                                <h3 className="font-semibold text-gray-800 capitalize">{key}</h3>
                                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(domain.concern_level)}`}>
                                                    {domain.concern_level}
                                                </span>
                                            </div>
                                            <p className="text-sm text-gray-600 mb-3">{domain.status}</p>
                                            <ul className="text-sm space-y-1">
                                                {domain.key_findings?.slice(0, 3).map((finding, i) => (
                                                    <li key={i} className="text-gray-600 flex items-start">
                                                        <span className="text-blue-500 mr-2">‚Ä¢</span>{finding}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Therapy Recommendations */}
                        {aiReport.therapy_recommendations && aiReport.therapy_recommendations.length > 0 && (
                            <div className="bg-white rounded-2xl p-8 mb-6 shadow-sm">
                                <h2 className="text-xl font-bold navy-text mb-6 flex items-center">
                                    <span className="mr-2">üíä</span> Recommended Therapies
                                </h2>
                                <div className="space-y-4">
                                    {aiReport.therapy_recommendations.map((therapy, idx) => (
                                        <div key={idx} className="border-l-4 border-blue-500 pl-4 py-3 bg-blue-50 rounded-r-lg">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h3 className="font-bold text-gray-800">{therapy.therapy_name}</h3>
                                                    <p className="text-sm text-blue-600 font-medium">{therapy.therapy_code}</p>
                                                </div>
                                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                                    therapy.urgency === 'Soon' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'
                                                }`}>
                                                    Priority {therapy.priority} - {therapy.urgency}
                                                </span>
                                            </div>
                                            <p className="text-gray-600 mt-2 text-sm">{therapy.recommendation_reason}</p>
                                            {therapy.treatment_plan && (
                                                <div className="mt-3 grid grid-cols-4 gap-2 text-xs">
                                                    <div className="bg-white p-2 rounded">
                                                        <span className="text-gray-500">Sessions:</span>
                                                        <span className="font-medium ml-1">{therapy.treatment_plan.sessions}</span>
                                                    </div>
                                                    <div className="bg-white p-2 rounded">
                                                        <span className="text-gray-500">Frequency:</span>
                                                        <span className="font-medium ml-1">{therapy.treatment_plan.frequency}</span>
                                                    </div>
                                                    <div className="bg-white p-2 rounded">
                                                        <span className="text-gray-500">Duration:</span>
                                                        <span className="font-medium ml-1">{therapy.treatment_plan.duration}</span>
                                                    </div>
                                                    <div className="bg-white p-2 rounded">
                                                        <span className="text-gray-500">Completion:</span>
                                                        <span className="font-medium ml-1">{therapy.treatment_plan.estimated_completion}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Lifestyle Recommendations */}
                        {aiReport.lifestyle_recommendations && aiReport.lifestyle_recommendations.length > 0 && (
                            <div className="bg-white rounded-2xl p-8 mb-6 shadow-sm">
                                <h2 className="text-xl font-bold navy-text mb-4 flex items-center">
                                    <span className="mr-2">üåø</span> Lifestyle Recommendations
                                </h2>
                                <ul className="space-y-3">
                                    {aiReport.lifestyle_recommendations.map((rec, idx) => (
                                        <li key={idx} className="flex items-start">
                                            <span className="text-green-500 mr-3 mt-1">‚úì</span>
                                            <span className="text-gray-700">{rec}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {/* Follow-up Notes */}
                        {aiReport.follow_up_notes && (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-2xl p-8 mb-6">
                                <h2 className="text-xl font-bold text-yellow-800 mb-4 flex items-center">
                                    <span className="mr-2">üìù</span> Follow-up Notes
                                </h2>
                                <p className="text-yellow-900">{aiReport.follow_up_notes}</p>
                            </div>
                        )}

                        {/* Disclaimer */}
                        <div className="bg-gray-50 border border-gray-200 rounded-2xl p-6 text-center">
                            <p className="text-sm text-gray-500">
                                {aiReport.disclaimer || 'This assessment is for wellness support purposes only and does not constitute medical diagnosis. Always consult with qualified healthcare professionals.'}
                            </p>
                            <p className="text-xs text-gray-400 mt-2">
                                Report generated by Celloxen Health Portal ‚Ä¢ {formatDate(assessment.created_at)}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<WellnessReport />);
    </script>
</body>
</html>
