"""
Iridology Analyzer - Claude AI Integration
Uses Anthropic Claude API for iris image analysis
British English throughout - NO medical diagnosis
"""

import anthropic
import json
import os
from typing import Dict, Optional
from datetime import datetime

def clean_base64_image(base64_string: str) -> str:
    """Remove data URL prefix from base64 string if present"""
    if "," in base64_string and base64_string.startswith("data:"):
        return base64_string.split(",", 1)[1]
    return base64_string


class IridologyAnalyzer:
    """Claude AI-powered iridology analysis - Wellness insights only"""
    
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key or os.getenv('ANTHROPIC_API_KEY', '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')
        self.client = anthropic.Anthropic(api_key=self.api_key)
        self.model = "claude-sonnet-4-20250514"
    
    def create_analysis_prompt(self, patient_info: Dict) -> str:
        """Create British English analysis prompt - NO diagnosis"""
        
        return f"""You are an expert iridology analyst providing wellness insights, NOT medical diagnoses.

CRITICAL INSTRUCTIONS:
1. Use BRITISH ENGLISH ONLY (analyse, colour, fibre, centre, optimise, whilst, programme)
2. NEVER diagnose medical conditions - use "may suggest", "patterns often seen in", "could indicate"
3. ALWAYS recommend GP consultation for concerning findings
4. Use warm, supportive, accessible language
5. Explain findings in plain English using analogies
6. Focus on wellness support, not medical treatment

PATIENT CONTEXT:
- Name: {patient_info.get('name', 'Patient')}
- Age: {patient_info.get('age', 'Unknown')} years
- Gender: {patient_info.get('gender', 'Unknown')}

ANALYSIS REQUIREMENTS:

1. CONSTITUTIONAL TYPE:
   - Determine: Lymphatic (blue), Haematogenic (brown), or Mixed (green/hazel)
   - Strength: Strong, Moderate, or Weak
   - Plain English explanation using house foundation analogy

2. BODY SYSTEMS (rate each: Excellent, Good, Fair, Needs Support):
   a) Digestive System
   b) Circulatory System
   c) Nervous System (look for NERVE RINGS - stress indicator)
   d) Musculoskeletal System
   e) Endocrine/Metabolic System (CRITICAL: examine pancreatic zone at 7 o'clock left eye, 5 o'clock right eye for C-108 diabetes therapy)

3. IRIS SIGNS:
   - Lacunae, crypts, pigmentation, nerve rings, scurf rim, radii solaris
   - Describe in PLAIN BRITISH ENGLISH, no jargon

4. CELLOXEN THERAPY PRIORITIES (1-5, 1=highest):
   - C-102: Vitality & Energy Support
   - C-104: Comfort & Mobility Support
   - C-105: Circulation & Heart Wellness
   - C-107: Stress & Relaxation Support (HIGH if nerve rings present)
   - C-108: Metabolic Balance Support (HIGH if pancreatic zone patterns - diabetes/blood sugar)
   
   For C-108: ALWAYS recommend GP consultation and blood sugar testing if pancreatic patterns found

5. WELLNESS RECOMMENDATIONS:
   - Diet, supplements, lifestyle, exercise
   - Constitutional type-specific
   - With GP consultation note for supplements

6. GP CONSULTATION:
   - If pancreatic patterns → "Recommend HbA1c and fasting glucose testing"
   - If heart patterns → "Discuss cardiovascular health"
   - NEVER diagnose, ALWAYS recommend evaluation

7. BIG PICTURE SUMMARY:
   Use car/garden/house analogy to explain findings accessibly

OUTPUT FORMAT (British English JSON):
{{
  "constitutional_type": "Lymphatic/Haematogenic/Mixed",
  "constitutional_strength": "Strong/Moderate/Weak",
  "plain_english_explanation": "...",
  "body_systems": {{
    "digestive": {{"rating": "Fair", "findings": [...], "wellness_implications": "..."}},
    "endocrine_metabolic": {{"rating": "Needs Support", "pancreatic_zone_patterns": true, "gp_consultation_recommended": true}}
  }},
  "iris_signs": [...],
  "therapy_priorities": [
    {{"code": "C-108", "priority": 1, "reason": "...", "diabetes_specific": true}}
  ],
  "wellness_recommendations": {{"diet": [...], "supplements": [...], "lifestyle": [...]}},
  "gp_consultation_summary": {{"recommended": true, "reasons": [...], "tests": ["HbA1c", "Fasting Glucose"]}},
  "big_picture": "Car analogy explanation..."
}}

REMEMBER:
- 100% British English
- NO medical diagnoses
- Warm, accessible language
- GP consultation for concerns
- Focus on wellness support"""

    async def analyse_single_iris(
        self, 
        image_base64: str, 
        eye_side: str,
        patient_info: Dict
    ) -> Dict:
        """Analyse single iris image using Claude API"""
        
        prompt = self.create_analysis_prompt(patient_info)
        
        try:
            message = self.client.messages.create(
                model=self.model,
                max_tokens=4000,
                messages=[
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": f"{prompt}\n\nPlease analyse this {eye_side} iris image in detail:"
                            },
                            {
                                "type": "image",
                                "source": {
                                    "type": "base64",
                                    "media_type": "image/jpeg",
                                    "data": image_base64
                                }
                            }
                        ]
                    }
                ]
            )
            
            response_text = message.content[0].text
            
            # Try to parse as JSON
            try:
                analysis = json.loads(response_text)
            except json.JSONDecodeError:
                # Clean markdown if present
                cleaned = response_text.replace('```json', '').replace('```', '').strip()
                try:
                    analysis = json.loads(cleaned)
                except:
                    analysis = {"raw_text": response_text, "parsed": False}
            
            return {
                "success": True,
                "eye_side": eye_side,
                "analysis": analysis,
                "model": self.model,
                "timestamp": datetime.now().isoformat()
            }
            
        except Exception as e:
            return {
                "success": False,
                "error": str(e),
                "eye_side": eye_side
            }
    
    async def analyse_bilateral(
        self,
        left_eye_base64: str,
        right_eye_base64: str,
        patient_info: Dict
    ) -> Dict:
        """Analyse both eyes and synthesise results"""

        # Clean base64 images
        left_eye_base64 = clean_base64_image(left_eye_base64)
        right_eye_base64 = clean_base64_image(right_eye_base64)
        
        # Analyse left eye
        # Clean base64 images
        left_eye_base64 = clean_base64_image(left_eye_base64)
        right_eye_base64 = clean_base64_image(right_eye_base64)

        left_result = await self.analyse_single_iris(
            left_eye_base64,
            "left",
            patient_info
        )
        
        if not left_result["success"]:
            return left_result
        
        # Analyse right eye
        right_result = await self.analyse_single_iris(
            right_eye_base64,
            "right",
            patient_info
        )
        
        if not right_result["success"]:
            return right_result
        
        # Synthesise both analyses
        synthesis_prompt = f"""Based on these bilateral iris analyses, create a comprehensive wellness report.

LEFT EYE FINDINGS:
{json.dumps(left_result.get('analysis', {}), indent=2)}

RIGHT EYE FINDINGS:
{json.dumps(right_result.get('analysis', {}), indent=2)}

PATIENT: {patient_info.get('name', 'Patient')}

Please synthesise into a complete report following the original format. 
Use 100% British English and focus on wellness support, not medical diagnosis.

Pay special attention to:
1. Pancreatic zone patterns (C-108 diabetes therapy)
2. Nerve rings (C-107 stress therapy)
3. Any patterns requiring GP consultation
4. Accessible explanations with analogies"""

        try:
            message = self.client.messages.create(
                model=self.model,
                max_tokens=4000,
                messages=[
                    {
                        "role": "user",
                        "content": synthesis_prompt
                    }
                ]
            )
            
            synthesis_text = message.content[0].text
            
            try:
                synthesis = json.loads(synthesis_text)
            except json.JSONDecodeError:
                cleaned = synthesis_text.replace('```json', '').replace('```', '').strip()
                try:
                    synthesis = json.loads(cleaned)
                except:
                    synthesis = {"raw_text": synthesis_text, "parsed": False}
            
            return {
                "success": True,
                "left_eye_analysis": left_result["analysis"],
                "right_eye_analysis": right_result["analysis"],
                "combined_analysis": synthesis,
                "confidence_score": self.calculate_confidence(synthesis),
                "timestamp": datetime.now().isoformat()
            }
            
        except Exception as e:
            return {
                "success": False,
                "error": str(e),
                "partial_results": {
                    "left": left_result,
                    "right": right_result
                }
            }
    
    def calculate_confidence(self, analysis: Dict) -> float:
        """Calculate AI confidence score (0-100)"""
        
        # Simple confidence based on completeness
        score = 50.0  # Base score
        
        if analysis.get("constitutional_type"):
            score += 10
        if analysis.get("body_systems"):
            score += 10
        if analysis.get("therapy_priorities"):
            score += 15
        if analysis.get("wellness_recommendations"):
            score += 10
        if analysis.get("big_picture"):
            score += 5
        
        return min(100.0, score)

